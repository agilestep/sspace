function Space(t={},e={},i="body"){this.rootElement=i,this.bindCollections=BIND_COLLECTION,this.bindDictionary={},this.templateDic={},this.templates=e,this.data=t,this.d=t,this.prepCustomTemplates(),this.parseCustomTags(),this.markAllDomBindings(),this.buildBindCollections(),this.buildLoops(),this.buildBindedData(this.data),this.buildRawExpressions(),this.bindInputs(),this.showHide()}function SpaceArray(t=[],e){this.list=[],this.length=0,this.render=!1,this.name=e;let i=this;this.push=function(t){return this[this.length]=t,this.length+=1,i.createArrayTriggers(this,t,this.length-1,freeArrayCount,this.name),this.list.push(t),i.render&&space.pushToList(this.name,t),this.list[this.list.length-1]},this.pop=function(){if(!(this.length<0))return this.length-=1,delete this[this.length],i.render&&space.popTheList(this.name),this.list.pop()},this.forEach=function(t){for(let e=0;e<this.list.length;e++)t(this.list[e])};for(let e=0;e<t.length;e++)this.push(t[e]);freeArrayCount+=1,this.render=!0}const bracketsPresent=function(t){return t.search(/\{.*\}/)>-1},buildBracketsRegex=t=>new RegExp("{s?"+t+"s?}","g"),SPACE_BIND_SIMBOL="s-bind",SPACE_EACH_SYMBOL="s-each",S_BOUND="s-bound",S_EVAL="s-eval",S_IF="s-if",S_ELSE="s-else",S_SHOW="s-show",BIND_COLLECTION={models:[],loops:[],expressions:[],directives:[],conditions:[],visible:[]},LIST_NAMES={"s-bind":"models","s-each":"loops","s-eval":"expressions","s-if":"conditions",directives:"directives","s-show":"visible"},SBINDS="sbind",HIDE_SHOW_STYLE=".s-hide{ visibility: hidden;}; .s-show{ visibility: visible; }",SPACE_DIRECTIVES=[SPACE_BIND_SIMBOL,SPACE_EACH_SYMBOL,S_BOUND,S_EVAL,S_IF,S_SHOW];let freeArrayCount=0;Space.prototype.prepCustomTemplates=function(){for(let t=0;t<this.templates.length;t++){let e=this.templates[t];this.templateDic[e.name]=e.html}},Space.prototype.parseCustomTags=function(){document.querySelectorAll(this.rootElement+" *").forEach((t=>{let e=t.tagName.toLowerCase();if(this.templateDic[e]){let i=this.getAllElementAttributes(t),s=t.innerHTML.toString(),n=this.createElementFromStr(this.templateDic[e].replaceAll("$CONTENT",s));t.parentNode.replaceChild(n,t);for(let t=0;t<i.nodes.length;t++)n.setAttribute(i.nodes[t],i.values[t])}}))},Space.prototype.createElementFromStr=function(t){var e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild},Space.prototype.getAllElementAttributes=function(t){for(var e,i=[],s=[],n=0,r=t.attributes,l=r.length;n<l;n++)e=r[n],i.push(e.nodeName),s.push(e.nodeValue);return{nodes:i,values:s}},Space.prototype.buildBindCollections=function(){let t=document.querySelectorAll("."+SBINDS),e="directive",i=this;t.forEach((t=>{e=t.getAttribute("slist");let s=[],n=[];if("directives"==e){let e=this.geElementRawText(t);s=this.getDirectivesKeys(e)}s.length>0&&s.forEach((function(e){let s="$item_"+t.getAttribute("sid");Array.isArray(i.bindDictionary[e])||(i.bindDictionary[e]=[]),Array.isArray(i.bindDictionary[s])||(i.bindDictionary[s]=[]),i.bindDictionary[e].push(t.getAttribute("sid")),i.bindDictionary[s].indexOf(e)<0&&i.bindDictionary[s].push(e),n.push(e)})),this.bindCollections[e].push({id:t.getAttribute("sid"),initialHTML:t.innerHTML,initialOuterHTML:t.outerHTML,bindedKeys:s});for(let e=0;e<n.length;e++){let i=n[e];this.data[i]&&(t.innerHTML=t.innerHTML.replace(buildBracketsRegex(i),this.data[i]))}}))},Space.prototype.markAllDomBindings=function(){const t=(t,e)=>{let i="directives";switch(!0){case t.hasAttribute(SPACE_EACH_SYMBOL):i=SPACE_EACH_SYMBOL;break;case t.hasAttribute(SPACE_BIND_SIMBOL):i=SPACE_BIND_SIMBOL;break;case t.hasAttribute(S_SHOW):i=S_SHOW;break;case t.hasAttribute(S_EVAL)||e.indexOf("${")>-1:i=S_EVAL;break;case t.hasAttribute(S_IF)||t.hasAttribute(S_ELSE):i=S_IF}return i},e=t=>SPACE_DIRECTIVES.find((e=>t.hasAttribute(e)));let i=document.querySelectorAll(this.rootElement+" *"),s=new RegExp("{.*?}"),n="directives",r=1;i.forEach((i=>{if("SCRIPT"!=i.tagName&&"STYLE"!=i.tagName){let l=this.geElementRawText(i);if(e(i)||l.match(s)){let e=t(i,l);n="s"+LIST_NAMES[e],i.setAttribute("sid",r),i.setAttribute("sList",LIST_NAMES[e]),i.classList.add("sid"+r,SBINDS,n),r+=1}}}))},Space.prototype.showHide=function(){for(let t=0;t<this.bindCollections.visible.length;t++){let e=this.bindCollections.visible[t],i=this.getItemsByClassName("sid"+e.id)[0],s=i.getAttribute(S_SHOW);this.getRawExpressionResult(s.replace("#","this."),this.data)?i.classList.add("s-show"):i.classList.add("s-hide")}var t=document.createElement("style");t.innerHTML=HIDE_SHOW_STYLE,document.body.appendChild(t)},Space.prototype.bindInputs=function(){let t=this;for(let e=0;e<this.bindCollections.models.length;e++){let i=this.bindCollections.models[e],s=this.getItemsByClassName("sid"+i.id)[0],n=s.getAttribute(SPACE_BIND_SIMBOL),r=this.data[n];s.value!=r&&(s.value=r);let l=function(e){t.data[n]=e.target.value};s.removeEventListener("input",l),s.addEventListener("input",l),s.setAttribute(S_BOUND,"true")}},Space.prototype.replaceLoopItems=function(t,e,i){return Object.keys(i).forEach((s=>{let n=["i.",":",e+"."];for(let e=0;e<n.length;e++)t=this.replaceDirective(t,n[e]+s,i[s])})),t},Space.prototype.getItem=function(t){return this.getItemsByClassName("sid"+t)[0]},Space.prototype.buildLoops=function(){let t=this.bindCollections.loops||[];for(let e=0;e<t.length;e++){let i=this.getItem(t[e].id),s=i.cloneNode(!0),n=i.getAttribute(SPACE_EACH_SYMBOL),r=null,l=!0,o=null,a=null,c=-1;this.data[n]&&this.data[n].forEach((p=>{c+=1;let d=n.toString()[0];a=t[e].initialHTML,a=this.replaceLoopItems(a,d,p),o=i,l?o.classList.add("s-loop-parent","s-collection-"+n):(o=s.cloneNode(!0),o.removeAttribute(SPACE_EACH_SYMBOL),r.parentNode.insertBefore(o,r.nextSibling)),o.setAttribute("parent_sid",s.getAttribute("sid")),o.setAttribute("data_name",d),o.classList.add("child_of_"+n+"_"+c,"loop_id_"+t[e].id,"parentSid"+s.getAttribute("sid")),r=o,o.innerHTML=a,l=!1}))}},Space.prototype.geElementRawText=function(t){let e="";for(let i=0;i<t.childNodes.length;i++)t.childNodes[i].nodeType===Node.TEXT_NODE&&(e+=t.childNodes[i].textContent.trim());return e},Space.prototype.getDirectivesKeys=function(t){let e,i=[],s=/{([^}]+)}/g;for(;e=s.exec(t);)i.push(e[1]);return i},Space.prototype.getItemsByClassName=function(t){let e=document.getElementsByClassName(t);return Array.from(e)},Space.prototype.triggerRefresh=function(t,e){let i=this;this.bindDictionary[t]&&this.bindDictionary[t].forEach((function(s){i.renderItem(s,t,e)})),this.buildRawExpressions()},Space.prototype.replaceDirective=function(t,e,i){try{return t.replaceAll(buildBracketsRegex(e),i)}catch(e){return t}},Space.prototype.buildRawExpressions=function(){for(let t=0;t<this.bindCollections.expressions.length;t++){let e=this.bindCollections.expressions[t],i=this.getItemsByClassName("sid"+e.id)[0];Space.prototype.buildRawExpression(i,e,this.data)}},Space.prototype.buildRawExpression=function(t,e,i){if(e.initialHTML.toString().includes("${")){let s=[],n=/{([^}]+)}/g,r=null;for(;r=n.exec(e.initialHTML);)s.push(r[1]);let l=e.initialHTML;s.forEach((t=>l=l.replaceAll("${"+t+"}",(this.executeRawExpression(t.replaceAll("#","this."),i)||"").toString()))),t.innerHTML=l}if(t.hasAttribute(S_EVAL)){let s=this.executeRawExpression(e.initialHTML.replaceAll("#","this."),i);t.innerHTML=null!=s?s.toString():""}},Space.prototype.executeRawExpression=function(t,e){let i=this.getRawExpressionResult(t,e);return i?i.toString():""},Space.prototype.getRawExpressionResult=function(expression,data){try{let obj=Object.assign({ex:function(){return eval(expression)}},data),result=obj.ex();return result}catch(t){return console.log("Template Exception: >>"+expression+"<<"),console.log(t),null}},Space.prototype.renderItem=function(t,e,i){let s=this;this.getItemsByClassName("sid"+t).forEach((function(n){for(let r=0;r<s.bindCollections.directives.length;r++)if(s.bindCollections.directives[r].id==t){let l=s.bindCollections.directives[r],o=s.replaceDirective(l.initialHTML,e,i),a=s.bindDictionary["$item_"+t]||[];for(let t=0;t<a.length;t++)o=s.replaceDirective(o,a[t],s.data[a[t]]);n.innerHTML=o}}))},Space.prototype.buildBindedData=function(t){let e=this,i={},s=this.bindCollections.loops.map((t=>t.id));for(const[n,r]of Object.entries(t))if(Array.isArray(r)){s.pop();i[n]=new SpaceArray(r,n)}else!function(){let t=r;Object.defineProperty(i,n,{get:()=>t,set(i){t=i,e.triggerRefresh(n,i)},configurable:!0,enumerable:!0})}();this.data=i},Space.prototype.pushToList=function(t,e){let i="s-collection-"+t,s=space.getItemsByClassName(i);for(let i=0;i<s.length;i++){let n=s[i],r=n.cloneNode(!0),l=r.getAttribute("sid"),o=this.bindCollections.loops.find((t=>t.id===l)).initialHTML;o=this.replaceLoopItems(o,t[0],e),r.innerHTML=o,r.removeAttribute(SPACE_EACH_SYMBOL);let a=space.getItemsByClassName("parentSid"+l),c=a[a.length-1],p=c.classList.value.split(" ").find((t=>t.indexOf("child_of_")>-1)),d=p.split("_"),h=d[d.length-1];h=Number(h)+1,d[d.length-1]=h;let u=d.join("_");r.classList.value=c.classList.value.replaceAll(p,u),r.classList.add("loop_id_"+l),r.setAttribute("parent_sid",l),r.setAttribute("data",l),r.setAttribute("data_name",t[0]),n.parentNode.insertBefore(r,c.nextSibling)}},Space.prototype.popTheList=function(t){let e="s-collection-"+t,i=space.getItemsByClassName(e);for(let t=0;t<i.length;t++){let e=i[t].cloneNode(!0).getAttribute("sid"),s=space.getItemsByClassName("parentSid"+e);s[s.length-1].remove()}},SpaceArray.prototype.triggerArrayChange=function(t,e,i,s){let n="child_of_"+s+"_"+t,r=space.getItemsByClassName(n);for(let t=0;t<r.length;t++){let e=r[t],s=e.getAttribute("parent_sid"),n=space.bindCollections.loops.find((t=>s==t.id)).initialHTML;n=space.replaceLoopItems(n,e.getAttribute("data_name"),i),e.innerHTML=n}},SpaceArray.prototype.createArrayTriggers=function(t,e,i,s,n){let r=this,l=this,o=s;return function(){let t=e;Object.defineProperty(l,i,{get:()=>t,set(e){t=e,l.list[i]=e,r.triggerArrayChange(i,o.toString(),e,n)},configurable:!0,enumerable:!0})}(),l};
